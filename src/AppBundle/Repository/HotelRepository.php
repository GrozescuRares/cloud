<?php

namespace AppBundle\Repository;

use AppBundle\Entity\User;
use AppBundle\Enum\PaginationConfig;
use AppBundle\Enum\UserConfig;

/**
 * HotelRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HotelRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * @return array
     */
    public function getHotelsWithReservations()
    {
        $hotels = $this->createQueryBuilder('hotel')
            ->innerJoin('hotel.reservations', 'reservations')
            ->groupBy('hotel.hotelId')
            ->getQuery()
            ->getResult();

        return $hotels;
    }

    /**
     * @param User $owner
     * @return float
     */
    public function getHotelsPagesNumber(User $owner)
    {
        $hotels = $this->createQueryBuilder('hotel')
            ->where('hotel.owner = :owner')
            ->setParameter('owner', $owner)
            ->getQuery()
            ->getResult();

        return ceil(count($hotels) / 5);
    }

    /**
     * @param User  $owner
     * @param mixed $offset
     * @param mixed $column
     * @param mixed $sort
     * @return mixed
     */
    public function paginateAndSortHotels(User $owner, $offset, $column = null, $sort = null)
    {
        $qb = $this->createQueryBuilder('hotel');
        $qb ->select('hotel, COUNT(hotel) as employees')
            ->innerJoin('hotel.users', 'users')
            ->innerJoin('users.role', 'role')
            ->where('hotel.owner =:owner')
            ->andWhere('role.description != :client')
            ->andWhere('role.description != :owner')
            ->setParameter('owner', $owner)
            ->setParameter('client', UserConfig::ROLE_CLIENT)
            ->setParameter('owner', UserConfig::ROLE_OWNER)
            ->setMaxResults(PaginationConfig::ITEMS)
            ->setFirstResult($offset)
            ->groupBy('hotel.hotelId');

        if (!empty($column) and !empty($sort)) {
            $qb->orderBy('hotel.'.$column, $sort);
        }

        return $qb->getQuery()->getResult();
    }
}
